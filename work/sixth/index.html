<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="format-detection" content="telephone=no" />
    <title>jQuery</title>
    <link rel="stylesheet" href="../../common/css/reset.css" />
    <link rel="stylesheet" href="../../common/css/base.css" />
    <link rel="stylesheet" href="./css/style.css" />
  </head>
  <body>
    <div class="wrap">
      <div class="container">
        <div class="header">
          <p class="header__title">Search Books!</p>
        </div>
        <div class="search">
          <div class="search__text">
            <input
              type="text"
              class="search__text__input"
              placeholder="検索する"
              data-js="search-word"
            />
          </div>
          <button class="search__btn" data-js="search-btn">検索する</button>
        </div>

        <div class="message" data-js="error-message"></div>
        <ul class="lists" data-js="book-lists"></ul>
      </div>
    </div>
    <script src="../../common/js/jquery.js"></script>
    <script src="./js/appid.js"></script>
    <script>

      // 実装！！！！！！！！
      $(function () {
        var pageNum = 0;
        var maxPage = 0;
        var searchWord = '';
        var $message = $(".message");
        var $lists = $(".lists");

        // 検索ボタンのクリック
        $(".search__btn").on("click", function () {
          pageNum = 1;
          searchWord = $(".search__text__input").val();
          search();
        });

        // 次へボタンのクリック
        $(document).on('click', '[data-js="page-next"]', function(e){
          e.preventDefault();
          if(pageNum !== maxPage){
            pageNum = pageNum + 1;
            search();
          }
        })

        // 前へボタンのクリック
        $(document).on('click', '[data-js="page-prev"]', function(e){
          e.preventDefault();
          if(pageNum !== 1){
            pageNum = pageNum - 1;
            search();
          }
        })

        // 検索
        function search(){
          $.ajax({
            url:"https://app.rakuten.co.jp/services/api/BooksTotal/Search/20130522",
            type: "GET",
            datatype: "json",
            data: {
              applicationId: appId,
              booksGenreId: "001",
              keyword: searchWord,
              page: pageNum,
              hits: "20",
            },
          })
            .done(function (data) {
              success(data);
            })
            .fail(function (xhr) {
              error(xhr);
            });
        }

        // リスト表示
        function success(data){
          reset();
          $(".search__btn").scrollTop(0);

          if (data.count > 0) {
            // 本の表示
            var list = "";
            $.each(data.Items, function (i, item) {
              list +=
                "<li class='lists__item'>" +
                "<div class='lists__item__inner'>" +
                "<a href='" +
                item.Item.itemUrl +
                "'class='lists__item__link' target='_blank'>" +
                "<img src='" +
                item.Item.mediumImageUrl +
                "' class='lists__item__img' alt=''>" +
                "<p class='lists__item__detail'>作品名：　" +
                item.Item.title +
                "</p>" +
                "<p class='lists__item__detail'>作者　：　" +
                item.Item.author +
                "</p>" +
                "<p class='lists__item__detail'>出版社：　" +
                item.Item.publisherName +
                "</p>" +
                "</a>" +
                "</div>" +
                "</li>";
            });
            $lists.prepend(list);
            pager(data);

          } else {
            // 検索結果が0件の時の挙動
            $message.html(
              "<p>検索結果が見つかりませんでした。<br>別のキーワードで検索して下さい。</p>"
            );
          }
        }

        // ページャ表示
        function pager(data){
          maxPage = data.pageCount

          var pagination = $(
            "<div class='pager' data-js='pager'>" +
              "<div class='counter'>" +
              "<span class='counter-current'>" +
              pageNum +
              "</span>" +
              "/" +
              "<span class='counter-all'>" +
              maxPage +
              "</span>" +
              "</div>" +
              "<div class='btn-wrapper'>" +
              "<a class='btn-item' data-js='page-prev' href=''>" +
              "前へ" +
              "</a>" +
              "<a class='btn-item' data-js='page-next' href=''>" +
              "次へ" +
              "</a>" +
              "</div>" +
              "</div>"
          );
          $lists.after(pagination);

          var $prev = $('[data-js="page-prev"]');
          var $next = $('[data-js="page-next"]');

          // 次へのキャンセル
          if(pageNum === maxPage){
            $next.addClass("disabled");
          }

          // 前へのキャンセル
          if(pageNum === 1){
            $prev.addClass("disabled");
          }
        }

        // リセット
        function reset(){
          $message.empty();
          $lists.empty();
          $(".pager").remove();
        }

        // エラー
        function error(object){
          reset();
          if (object.status === 0) {
            $message.text("通信に失敗しました。インターネットの接続をご確認ください。");
          } else if (object.status === 400) {
            $message.text("検索文字が入力されていません。");
          } else if (object.status === 429) {
            $message.text("リクエスト過多です。しばらく時間を置いてからお試しください。");
          } else {
            $message.text("わからん！！！");
          }
        }

      });

    </script>
  </body>
</html>
