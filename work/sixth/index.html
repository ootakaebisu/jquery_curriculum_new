<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="format-detection" content="telephone=no" />
    <title>jQuery</title>
    <link rel="stylesheet" href="../../common/css/reset.css" />
    <link rel="stylesheet" href="../../common/css/base.css" />
    <link rel="stylesheet" href="./css/style.css" />
  </head>
  <body>
    <div class="wrap">
      <div class="container">
        <div class="header">
          <p class="header__title">Search Books!</p>
        </div>
        <div class="search">
          <div class="search__text">
            <input
              type="text"
              class="search__text__input"
              placeholder="検索する"
              data-js="search-word"
            />
          </div>
          <button class="search__btn" data-js="search-btn">検索する</button>
        </div>

        <div class="message" data-js="error-message"></div>
        <ul class="lists" data-js="book-lists"></ul>
      </div>
    </div>
    <script src="../../common/js/jquery.js"></script>
    <script src="./js/appid.js"></script>
    <script>

      // 実装！！！！！！！！
      $(function () {
        var pageNum = 0;
        var searchWord = '';
        var $message = $(".message");
        var $lists = $(".lists");

        // リセット関数
        var reset = function(){
          $message.empty();
          $lists.empty();
          $(".pager").remove();
        }

        // 通信が成功したときの挙動
        var success = function(data){
          reset();
          if (data.count > 0) {
            // 本を並べる
            var list = "";
            // firstData = 20*(pageNum - 1)
            // console.log(pageNum)
            $.each(data.Items, function (i, item) {
              list +=
                "<li class='lists__item'>" +
                "<div class='lists__item__inner'>" +
                "<a href='" +
                item.Item.itemUrl +
                "'class='lists__item__link' target='_blank'>" +
                "<img src='" +
                item.Item.mediumImageUrl +
                "' class='lists__item__img' alt=''>" +
                "<p class='lists__item__detail'>作品名：　" +
                item.Item.title +
                "</p>" +
                "<p class='lists__item__detail'>作者　：　" +
                item.Item.author +
                "</p>" +
                "<p class='lists__item__detail'>出版社：　" +
                item.Item.publisherName +
                "</p>" +
                "</a>" +
                "</div>" +
                "</li>";
            });
            $("ul").prepend(list);

            // ページネーションを配置する
            var pagination = $(
              "<div class='pager' data-js='pager'>" +
                "<div class='counter'>" +
                "<span class='counter-current'>" +
                pageNum +
                "</span>" +
                "/" +
                "<span class='counter-all'>" +
                data.pageCount +
                "</span>" +
                "</div>" +
                "<div class='btn-wrapper'>" +
                "<a class='btn-item' data-js='page-prev' href=''>" +
                "前へ" +
                "</a>" +
                "<a class='btn-item' data-js='page-next' href=''>" +
                "次へ" +
                "</a>" +
                "</div>" +
                "</div>"
            );
            $("ul").after(pagination);

            // ページネーションの機能設定
            var $prev = $('.btn-item').filter(function(){return($(this).data('js') === 'page-prev');});
            var $next = $('.btn-item').filter(function(){return($(this).data('js') === 'page-next');});

            // 前へボタンクリック
            if(pageNum === 1){
              $prev.addClass("disabled");
              $prev.on('click', function(e){
                e.preventDefault();
              })
            } else {
              $prev.on('click', function(e){
                e.preventDefault();
                pageNum = pageNum - 1;
                result();
              })
            }

            // 次へボタンクリック
            if(pageNum === data.pageCount){
              $next.addClass("disabled");
              $next.on('click', function(e){
                e.preventDefault();
              })
            } else {
              $next.on('click', function(e){
                e.preventDefault();
                pageNum = pageNum + 1;
                result();
              })
            }

          } else {
            $message.html(
              "<p>検索結果が見つかりませんでした。<br>別のキーワードで検索して下さい。</p>"
            );
          }
        }

        // ボタンクリック後の挙動
        var btn_click = function(){
          $.ajax({
            url:"https://app.rakuten.co.jp/services/api/BooksTotal/Search/20130522",
            type: "GET",
            datatype: "json",
            data: {
              applicationId: appId,
              booksGenreId: "001",
              keyword: searchWord,
              page: pageNum,
              first: firstData,
              hits: "20",
            },
          })
            .done(function (data) {
              success(data);
            })
            .fail(function (xhr) {
              reset();
              if (xhr.status === 0) {
                $message.text("③オフライン！");
              } else if (xhr.status === 400) {
                $message.text("①空欄！");
              } else if (xhr.status === 429) {
                $message.text("②クリックしすぎ！");
              } else {
                $message.text("わからん！！！");
              }
            });
        }

        var result = function(){
          $.ajax({
            url:"https://app.rakuten.co.jp/services/api/BooksTotal/Search/20130522",
            type: "GET",
            datatype: "json",
            data: {
              applicationId: appId,
              booksGenreId: "001",
              keyword: searchWord,
              page: pageNum,
              hits: "20",
            },
          })
            .done(function (data) {
              success(data);
            })
            .fail(function (xhr) {
              reset();
              if (xhr.status === 0) {
                $message.text("③オフライン！");
              } else if (xhr.status === 400) {
                $message.text("①空欄！");
              } else if (xhr.status === 429) {
                $message.text("②クリックしすぎ！");
              } else {
                $message.text("わからん！！！");
              }
            });
        }

        $(".search__btn").on("click", function () {
          pageNum = 1;
          searchWord = $(".search__text__input").val();

          result();
        });
      });

    </script>
  </body>
</html>
